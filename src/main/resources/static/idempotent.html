<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>HZFarm — тест идемпотентности</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
          --bg: #0f172a;
          --bg2: #020617;
          --card: #111827;
          --text: #e2e8f0;
          --muted: #94a3b8;
          --border: #1f2937;
          --accent: #38bdf8;
          --danger: #ef4444;
          --success: #22c55e;
        }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
          color: var(--text);
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          padding: 16px;
        }
        h1 {
          margin-top: 0;
          font-size: 20px;
        }
        .subtitle {
          font-size: 12px;
          color: var(--muted);
          margin-bottom: 16px;
        }
        .flex {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
        }
        .card {
          background: rgba(15, 23, 42, 0.96);
          border: 1px solid rgba(30, 64, 175, 0.45);
          border-radius: 10px;
          padding: 12px 14px;
          margin-bottom: 12px;
          box-shadow: 0 12px 30px rgba(15, 23, 42, 0.8);
        }
        .card-top {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
        }
        label {
          display: inline-block;
          margin-bottom: 4px;
          font-size: 11px;
        }
        input, select {
          background: var(--bg2);
          border: 1px solid var(--border);
          border-radius: 6px;
          padding: 5px 7px;
          color: var(--text);
          font-size: 12px;
        }
        input:focus, select:focus {
          outline: none;
          border-color: var(--accent);
          box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
        }
        .field-row {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
          margin-bottom: 6px;
        }
        .field {
          display: flex;
          flex-direction: column;
          gap: 2px;
          min-width: 110px;
        }
        .btn-primary {
          border-radius: 999px;
          padding: 6px 14px;
          border: 1px solid rgba(56, 189, 248, 0.7);
          background: radial-gradient(circle at top left, #0ea5e9 0, #0f172a 48%, #020617 100%);
          color: #e5f4ff;
          font-size: 13px;
          font-weight: 500;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
          transition: background 0.18s ease, transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s;
        }
        .btn-primary:hover {
          transform: translateY(-1px);
          box-shadow: 0 8px 20px rgba(56, 189, 248, 0.3);
        }
        .btn-primary:active {
          transform: translateY(0);
          box-shadow: 0 4px 12px rgba(15, 23, 42, 0.7);
        }
        .btn-primary.loading {
          opacity: 0.7;
          cursor: wait;
        }
        .btn-primary.success {
          background: radial-gradient(circle at top left, var(--success) 0, #047857 48%, #022c22 100%);
          border-color: rgba(34, 197, 94, 0.9);
          box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
        }
        .btn-ghost {
          background: rgba(15,23,42,0.7);
          border-radius: 999px;
          border: 1px solid rgba(148, 163, 184, 0.4);
          color: var(--muted);
          font-size: 11px;
          padding: 4px 10px;
          cursor: pointer;
        }
        .btn-ghost:hover {
          border-color: rgba(148, 163, 184, 0.8);
          color: var(--text);
        }

        .spinner {
          width: 14px;
          height: 14px;
          border-radius: 999px;
          border: 2px solid rgba(148, 163, 184, 0.4);
          border-top-color: #38bdf8;
          animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }

        .op-card-title {
          font-size: 14px;
          font-weight: 600;
          margin-bottom: 6px;
        }
        .op-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
          margin-bottom: 6px;
        }
        .op-status {
          font-size: 11px;
          color: var(--muted);
          white-space: nowrap;
        }
        .op-status.error {
          color: var(--danger);
        }
        .op-status.ok {
          color: var(--success);
        }
        .op-meta {
          font-size: 11px;
          color: var(--muted);
          margin-bottom: 6px;
          display: flex;
          justify-content: space-between;
          gap: 8px;
          align-items: baseline;
          flex-wrap: wrap;
        }
        .op-meta code {
          font-size: 11px;
          background: rgba(15,23,42,0.8);
          padding: 2px 4px;
          border-radius: 4px;
          border: 1px solid rgba(30,64,175,0.5);
        }
        pre {
          background: var(--bg2);
          border: 1px solid var(--border);
          border-radius: 8px;
          padding: 10px;
          font-size: 12px;
          max-height: 300px;
          overflow: auto;
          white-space: pre-wrap;
          word-break: break-word;
        }
        .small { font-size: 11px; color: var(--muted); }
    </style>
</head>
<body>

<h1>HZFarm — тест идемпотентности</h1>
<div class="subtitle">
    Вторая страница для теста Idempotency-Key. Логин и BASE URL берутся из localStorage (как в <code>index.html</code>).
</div>

<!-- Верхняя панель: BASE URL и access -->
<div class="card">
    <div class="card-top">
        <div>
            <label for="baseUrl">BASE URL:</label><br/>
            <input id="baseUrl" type="text" style="width: 260px;" />
            <button id="btn-save-base" class="btn-ghost">Сохранить</button>
        </div>
        <div>
            <div class="small">Access token (из localStorage):</div>
            <div class="small">
                <code id="access-text">(нет)</code>
                <button id="btn-clear-access" class="btn-ghost">Очистить</button>
            </div>
        </div>
    </div>
    <div class="small" style="margin-top:6px;">
        Ключи: <code>hzf_base_url</code> и <code>hzf_access_token</code>.
        Авторизуйся на <code>index.html</code>, потом открывай <code>idempotent.html</code>.
    </div>
</div>

<!-- Операции -->
<div class="flex">

    <!-- Создать дом -->
    <div class="card" id="card-create" style="flex:1 1 280px;">
        <div class="op-card-title">Создать дом</div>
        <div class="op-header">
            <button class="btn-primary" id="btn-create">
                <span class="btn-label">Создать дом</span>
                <span class="spinner hidden" id="spinner-create"></span>
            </button>
            <span class="op-status" id="status-create">Готово</span>
        </div>
        <div class="op-meta">
            <span>Idempotency-Key: <code id="key-create">—</code></span>
            <span class="small">до 3 попыток с тем же ключом</span>
        </div>
        <div class="field-row">
            <div class="field">
                <label for="type-create">Тип</label>
                <select id="type-create">
                    <option value="FARM">FARM</option>
                    <option value="STORAGE">STORAGE</option>
                    <option value="DECOR">DECOR</option>
                    <option value="BRA">BRA</option>
                </select>
            </div>
            <div class="field">
                <label for="skin-create">Skin</label>
                <input id="skin-create" type="text" value="default" />
            </div>
        </div>
        <div class="field-row">
            <div class="field">
                <label for="x-create">X</label>
                <input id="x-create" type="number" value="0" />
            </div>
            <div class="field">
                <label for="y-create">Y</label>
                <input id="y-create" type="number" value="0" />
            </div>
        </div>
        <div class="small">
            Мутация: <code>buildHouse(input: { type, skin, locationX, locationY })</code>.
        </div>
    </div>

    <!-- Улучшить уровень -->
    <div class="card" id="card-upgrade" style="flex:1 1 280px;">
        <div class="op-card-title">Улучшить уровень</div>
        <div class="op-header">
            <button class="btn-primary" id="btn-upgrade">
                <span class="btn-label">Улучшить уровень</span>
                <span class="spinner hidden" id="spinner-upgrade"></span>
            </button>
            <span class="op-status" id="status-upgrade">Готово</span>
        </div>
        <div class="op-meta">
            <span>Idempotency-Key: <code id="key-upgrade">—</code></span>
            <span class="small">HouseId фиксируется в теле</span>
        </div>
        <div class="field-row">
            <div class="field" style="min-width:180px;">
                <label for="houseId-upgrade">House ID</label>
                <input id="houseId-upgrade" type="text" placeholder="например, 1" />
            </div>
        </div>
        <div class="small">
            Мутация: <code>updateHouseLevel(input: { houseId })</code>.
        </div>
    </div>

    <!-- Убрать дом -->
    <div class="card" id="card-remove" style="flex:1 1 280px;">
        <div class="op-card-title">Убрать дом</div>
        <div class="op-header">
            <button class="btn-primary" id="btn-remove">
                <span class="btn-label">Убрать дом</span>
                <span class="spinner hidden" id="spinner-remove"></span>
            </button>
            <span class="op-status" id="status-remove">Готово</span>
        </div>
        <div class="op-meta">
            <span>Idempotency-Key: <code id="key-remove">—</code></span>
            <span class="small">результат кэшируется в Redis</span>
        </div>
        <div class="field-row">
            <div class="field" style="min-width:180px;">
                <label for="houseId-remove">House ID</label>
                <input id="houseId-remove" type="text" placeholder="например, 1" />
            </div>
        </div>
        <div class="small">
            Мутация: <code>removeHouse(input: { houseId })</code>.
        </div>
    </div>

</div>

<!-- Лог -->
<div class="card">
    <div class="op-card-title">Лог запросов / ответов</div>
    <div class="small" style="margin-bottom:6px;">
        Здесь видно все попытки (idempotency key, попытка, статус, ошибки).
    </div>
    <pre id="log"></pre>
</div>

<script>
    // === Константы такие же, как в index.html ===
    const ACCESS_KEY = "hzf_access_token";
    const BASE_KEY   = "hzf_base_url";

    // === Хелперы ===
    function log() {
      const el = document.getElementById("log");
      const line = Array.from(arguments).map(a => {
        if (typeof a === "string") return a;
        try { return JSON.stringify(a, null, 2); } catch (e) { return String(a); }
      }).join(" ");
      el.textContent = line + "\n" + el.textContent;
      console.log.apply(console, arguments);
    }

    function getBaseUrl() {
      const input = document.getElementById("baseUrl");
      const v = (input.value || "").trim();
      return v || window.location.origin;
    }

    function loadBaseUrl() {
      const saved = localStorage.getItem(BASE_KEY);
      document.getElementById("baseUrl").value = saved || window.location.origin;
    }

    function saveBaseUrl() {
      const v = document.getElementById("baseUrl").value.trim();
      localStorage.setItem(BASE_KEY, v);
      log("BASE URL сохранён:", v);
    }

    function getAccess() {
      return localStorage.getItem(ACCESS_KEY);
    }

    function setAccess(token) {
      if (token) localStorage.setItem(ACCESS_KEY, token);
      else localStorage.removeItem(ACCESS_KEY);
      renderAccess();
    }

    function renderAccess() {
      const t = getAccess();
      const el = document.getElementById("access-text");
      if (!t) {
        el.textContent = "(нет)";
        return;
      }
      const short = t.length > 20 ? t.slice(0, 20) + "…" : t;
      el.textContent = short;
    }

    function generateIdemKey() {
      if (window.crypto && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return "idem-" + Date.now() + "-" + Math.random().toString(16).slice(2);
    }

    function wait(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // === UI-контроллеры для операций ===
    function createOpController(name) {
      const card    = document.getElementById("card-" + name);
      const btn     = document.getElementById("btn-" + name);
      const spinner = document.getElementById("spinner-" + name);
      const statusEl= document.getElementById("status-" + name);
      const keyEl   = document.getElementById("key-" + name);

      function setStatus(text, mode) {
        statusEl.textContent = text;
        statusEl.classList.remove("error", "ok");
        if (mode === "error") statusEl.classList.add("error");
        if (mode === "ok")    statusEl.classList.add("ok");
      }

      return {
        btn,
        setKey(key) {
          keyEl.textContent = key || "—";
        },
        setLoading(isLoading) {
          if (isLoading) {
            btn.disabled = true;
            btn.classList.add("loading");
            spinner.classList.remove("hidden");
          } else {
            btn.disabled = false;
            btn.classList.remove("loading");
            spinner.classList.add("hidden");
          }
        },
        flashSuccess() {
          btn.classList.add("success");
          setTimeout(() => btn.classList.remove("success"), 2000);
        },
        setStatus
      };
    }

    const uiCreate  = createOpController("create");
    const uiUpgrade = createOpController("upgrade");
    const uiRemove  = createOpController("remove");

    // === Запрос с Idempotency-Key + ретраями ===
    async function fetchGraphQLIdem({ baseUrl, access, idemKey, query, variables, timeoutMs }) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);

      let resp;
      try {
        resp = await fetch(baseUrl + "/graphql", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + access,
            "Idempotency-Key": idemKey
          },
          body: JSON.stringify({ query, variables }),
          signal: controller.signal
        });
      } catch (e) {
        clearTimeout(timer);
        const error = new Error("Сетевая ошибка: " + e.message);
        error.retryable = true;
        error.reason = "network";
        error.original = e;
        throw error;
      }
      clearTimeout(timer);

      // 202 от фильтра — запрос ещё в обработке, пробуем повторить
      if (resp.status === 202) {
        const txt = await resp.text().catch(() => "");
        const error = new Error("Запрос ещё обрабатывается (202)");
        error.retryable = true;
        error.reason = "in_progress";
        error.raw = txt;
        throw error;
      }

      let json;
      try {
        json = await resp.json();
      } catch (e) {
        const text = await resp.text().catch(() => "");
        const error = new Error("Не удалось прочитать JSON ответа");
        error.retryable = resp.status >= 500;
        error.reason = "parse";
        error.raw = text;
        throw error;
      }

      if (!resp.ok) {
        const error = new Error("HTTP " + resp.status);
        error.retryable = resp.status >= 500;
        error.reason = "http";
        error.payload = json;
        throw error;
      }

      if (json.errors) {
        const error = new Error("GraphQL ошибка");
        error.retryable = false; // бизнес-ошибка, ретраем нет смысла
        error.reason = "gql";
        error.payload = json.errors;
        throw error;
      }

      return json;
    }

    async function runOperationWithIdempotency(opName, ui, query, variables) {
      const baseUrl = getBaseUrl();
      const access  = getAccess();
      if (!access) {
        ui.setStatus("Нет access — авторизуйся", "error");
        log("❗ Нет access, зайди через Telegram / refresh.");
        return;
      }

      const idemKey = generateIdemKey();
      ui.setKey(idemKey);
      ui.setStatus("Отправка…");
      ui.setLoading(true);

      const maxRetries = 3;
      const timeoutMs  = 8000;
      let attempt = 0;

      while (attempt < maxRetries) {
        attempt++;
        try {
          log(`→ ${opName}: попытка ${attempt}, key=${idemKey}`);
          const result = await fetchGraphQLIdem({
            baseUrl, access, idemKey, query, variables, timeoutMs
          });
          ui.setLoading(false);
          ui.setStatus(`Успех (попытка ${attempt})`, "ok");
          ui.flashSuccess();
          log(`✅ ${opName} завершён (попытка ${attempt}, key=${idemKey})`, result);
          return;
        } catch (e) {
          const info = {
            message: e.message,
            reason: e.reason,
            retryable: e.retryable,
            payload: e.payload,
            raw: e.raw
          };
          log(`⚠️ ${opName} ошибка на попытке ${attempt}, key=${idemKey}`, info);

          if (!e.retryable || attempt >= maxRetries) {
            ui.setLoading(false);
            ui.setStatus("Ошибка: " + (e.message || "см. лог"), "error");
            log(`❌ ${opName} окончательно упал (retryable=${e.retryable})`);
            return;
          }

          const delay = attempt * 1500; // 1.5s, 3s, 4.5s
          ui.setStatus(`Проблема (${e.reason || "неизвестно"}), retry через ${delay/1000} с…`);
          await wait(delay);
          ui.setLoading(true);
        }
      }
    }

    // === Обработчики кнопок ===
    document.getElementById("btn-save-base").onclick = saveBaseUrl;
    document.getElementById("btn-clear-access").onclick = () => {
      setAccess(null);
      log("Access очищен вручную.");
    };

    // Создать дом
    document.getElementById("btn-create").onclick = () => {
      const type = document.getElementById("type-create").value;
      const skin = document.getElementById("skin-create").value || "default";
      const x    = parseInt(document.getElementById("x-create").value || "0", 10);
      const y    = parseInt(document.getElementById("y-create").value || "0", 10);

      const query = `
        mutation($input: BuildHouseInput!) {
          buildHouse(input: $input) {
            id type level skin locationX locationY
          }
        }
      `;
      const variables = { input: { type, skin, locationX: x, locationY: y } };

      runOperationWithIdempotency("Создать дом", uiCreate, query, variables);
    };

    // Улучшить уровень
    document.getElementById("btn-upgrade").onclick = () => {
      const houseId = document.getElementById("houseId-upgrade").value.trim();
      if (!houseId) {
        uiUpgrade.setStatus("Укажи houseId", "error");
        return;
      }

      const query = `
        mutation($input: HouseIdInput!) {
          updateHouseLevel(input: $input) {
            id level
          }
        }
      `;
      const variables = { input: { houseId } };

      runOperationWithIdempotency("Улучшить уровень", uiUpgrade, query, variables);
    };

    // Убрать дом
    document.getElementById("btn-remove").onclick = () => {
      const houseId = document.getElementById("houseId-remove").value.trim();
      if (!houseId) {
        uiRemove.setStatus("Укажи houseId", "error");
        return;
      }

      const query = `
        mutation($input: HouseIdInput!) {
          removeHouse(input: $input) {
            success
            deletedHouseId
          }
        }
      `;
      const variables = { input: { houseId } };

      runOperationWithIdempotency("Убрать дом", uiRemove, query, variables);
    };

    // === Init ===
    loadBaseUrl();
    renderAccess();
    log("Страница idempotent.html загружена. Авторизуйся на index.html, затем тестируй мутации с Idempotency-Key.");
</script>

</body>
</html>
