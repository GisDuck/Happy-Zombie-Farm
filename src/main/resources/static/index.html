<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>hzfarm</title>
</head>
<body>
–ü—Ä–∏–≤–µ—Ç üëã

<script async src="https://telegram.org/js/telegram-widget.js?22"
        data-telegram-login="hzfarm_bot"
        data-size="large"
        data-onauth="onTelegramAuth(user)"></script>

<script>
    const BASE_URL = "https://hzfarm.ru"; // –µ—Å–ª–∏ —Ç–µ—Å—Ç–∏—à—å –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –ø–æ–º–µ–Ω—è–π

    async function onTelegramAuth(user) {
      try {
        // 1. –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        const authResp = await fetch(`${BASE_URL}/auth/telegram-login`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(user),
          credentials: "include"
        });

        // –ø—Ä–æ–±—É–µ–º —Å—á–∏—Ç–∞—Ç—å —Ç–æ–∫–µ–Ω
        let authBodyText = await authResp.text();
        let token;
        try {
          const json = JSON.parse(authBodyText);
          token = json.accessToken || json.access_token || json.token;
        } catch (e) {
          // –∑–Ω–∞—á–∏—Ç –±—ç–∫ –æ—Ç–¥–∞–ª –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫—É
          token = authBodyText;
        }

        if (!token) {
          alert("–¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–∏—à—ë–ª –æ—Ç –±—ç–∫–∞: " + authBodyText);
          return;
        }

        console.log("access token:", token);
        localStorage.setItem("access_token", token);

        // 2. –∑–∞–ø—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥–∞ (GraphQL)
        const cfgResp = await fetch(`${BASE_URL}/graphql`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            query: "{ getHousesInfoCfg getGameLogicCfg }"
          })
        });
        const cfgJson = await cfgResp.json();
        console.log("config:", cfgJson);
        alert("config ok, —Å–º–æ—Ç—Ä–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏");

        // 3. –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º—è—Å–∞
        const meatResp = await fetch(`${BASE_URL}/graphql`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            query: "mutation { updatePlayerMeat { id username meat gold brain } }"
          })
        });
        const meatJson = await meatResp.json();
        console.log("updatePlayerMeat:", meatJson);
        alert("meat –æ–±–Ω–æ–≤–ª—ë–Ω, —Å–º–æ—Ç—Ä–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏");

      } catch (err) {
        console.error(err);
        alert("–û—à–∏–±–∫–∞: " + err);
      }
    }
</script>

</body>
</html>
