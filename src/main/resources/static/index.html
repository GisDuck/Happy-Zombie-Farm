<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>HZFarm – тест авторизации</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
        }
        a {
            color: #38bdf8;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px 16px 40px;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        h2 {
            margin-top: 24px;
            margin-bottom: 8px;
        }
        nav {
            margin-bottom: 24px;
        }
        nav a, nav button {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 8px;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid #334155;
            background: #020617;
            color: #e5e7eb;
            text-decoration: none;
            cursor: pointer;
            font-size: 14px;
        }
        nav button:hover,
        nav a:hover {
            background: #1f2937;
        }
        button {
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid #334155;
            background: #020617;
            color: #e5e7eb;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #1f2937;
        }
        section {
            margin-bottom: 24px;
            padding: 16px;
            border-radius: 16px;
            background: rgba(15,23,42,0.9);
            border: 1px solid #1f2937;
        }
        #log {
            background: #020617;
            border-radius: 12px;
            padding: 12px;
            max-height: 260px;
            overflow: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .small {
            font-size: 12px;
            color: #9ca3af;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>HZFarm – тест авторизации</h1>
    <p class="small">
        Главная страница. Здесь проверяем вход через Telegram, refresh и logout.
    </p>

    <nav>
        <a href="/index.html">На главную</a>
        <a href="/idem.html">Перейти на страницу GraphQL / idem</a>
    </nav>

    <section>
        <h2>Вход через Telegram</h2>
        <p class="small">
            Нажми на кнопку ниже, пройди авторизацию в Telegram – на бэке вызовется
            <code>POST /auth/telegram-login</code>, и установятся cookie с access/refresh.
        </p>
        <div id="telegram-login-container">
            <script async src="https://telegram.org/js/telegram-widget.js?22"
                    data-telegram-login="hzfarm_bot"
                    data-size="large"
                    data-onauth="onTelegramAuth(user)"
                    data-request-access="write">
            </script>
        </div>
    </section>

    <section>
        <h2>Управление токенами</h2>
        <p class="small">
            Эти кнопки ходят на <code>/auth/refresh</code> и <code>/auth/logout</code>.
            CSRF на /auth/** отключён, поэтому можно просто делать POST.
        </p>
        <button id="btn-refresh">POST /auth/refresh (обновить access/refresh)</button>
        <button id="btn-logout">POST /auth/logout (выход)</button>
    </section>

    <section>
        <h2>Логи</h2>
        <pre id="log"></pre>
    </section>
</div>

<script>
    function appendLog(message, obj) {
        const logEl = document.getElementById("log");
        const ts = new Date().toISOString().substring(11, 19);
        let line = "[" + ts + "] " + message;
        if (obj !== undefined) {
            try {
                line += "\n" + JSON.stringify(obj, null, 2);
            } catch (e) {
                line += "\n" + String(obj);
            }
        }
        logEl.textContent = line + "\n" + logEl.textContent;
    }

    async function onTelegramAuth(user) {
        appendLog("Получены данные от Telegram, отправляем на /auth/telegram-login …", user);

        const payload = {
            id: user.id,
            first_name: user.first_name,
            last_name: user.last_name,
            username: user.username,
            photo_url: user.photo_url,
            auth_date: user.auth_date,
            hash: user.hash
        };

        try {
            const resp = await fetch("/auth/telegram-login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            appendLog("Ответ /auth/telegram-login: " + resp.status + " " + resp.statusText);

            if (resp.ok) {
                appendLog("Успешный вход через Telegram. Можно идти на /idem.html");
            } else {
                const text = await resp.text();
                appendLog("Тело ошибки при логине:", text);
            }
        } catch (e) {
            appendLog("Ошибка при запросе /auth/telegram-login", e);
        }
    }

    async function callAuth(path) {
        appendLog("POST " + path + " …");
        try {
            const resp = await fetch(path, {
                method: "POST",
                credentials: "include"
            });
            const text = await resp.text();
            appendLog("Ответ " + path + ": " + resp.status + " " + resp.statusText, text);
        } catch (e) {
            appendLog("Ошибка при запросе " + path, e);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const btnRefresh = document.getElementById("btn-refresh");
        const btnLogout = document.getElementById("btn-logout");

        btnRefresh.addEventListener("click", function () {
            callAuth("/auth/refresh");
        });

        btnLogout.addEventListener("click", function () {
            callAuth("/auth/logout");
        });
    });
</script>
</body>
</html>
