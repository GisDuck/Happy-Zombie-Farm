<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>hzfarm — тесты</title>
    <style>
        body {
          font-family: sans-serif;
          padding: 16px;
          background: #0f172a;
          color: #e2e8f0;
        }
        h1 { margin-top: 0; }
        .row { margin-bottom: 14px; }
        button {
          margin: 4px 4px 4px 0;
          padding: 6px 10px;
          background: #1f2937;
          border: 1px solid #334155;
          border-radius: 4px;
          color: #e2e8f0;
          cursor: pointer;
        }
        button:hover { background: #334155; }
        pre {
          background: #020617;
          padding: 8px;
          border: 1px solid #1e293b;
          border-radius: 4px;
          max-height: 260px;
          overflow: auto;
          font-size: 12px;
        }
        label {
          display: inline-block;
          margin-right: 8px;
          margin-bottom: 4px;
        }
        input, select {
          background: #020617;
          border: 1px solid #1e293b;
          border-radius: 4px;
          padding: 4px 6px;
          color: #e2e8f0;
          margin-right: 4px;
          margin-bottom: 4px;
        }
        fieldset {
          border: 1px solid #1e293b;
          border-radius: 6px;
          padding: 10px;
        }
        legend {
          font-size: 13px;
          color: #94a3b8;
        }
    </style>
</head>
<body>
<h1>hzfarm тестовая страница</h1>

<div class="row">
    <!-- виджет телеги -->
    <script async src="https://telegram.org/js/telegram-widget.js?22"
            data-telegram-login="hzfarm_bot"
            data-size="large"
            data-onauth="onTelegramAuth(user)"></script>
</div>

<div class="row">
    <strong>Текущий access из localStorage:</strong>
    <span id="access-text">(нет)</span>
    <button id="btn-clear">Очистить access</button>
</div>

<div class="row">
    <strong>AUTH:</strong><br>
    <button id="btn-refresh">/auth/refresh (получить новый access по cookie)</button>
    <button id="btn-check-refresh">ПРОВЕРИТЬ refresh</button>
</div>

<div class="row">
    <strong>GraphQL базовые:</strong><br>
    <button id="btn-gql-player">getPlayer</button>
    <button id="btn-gql-houses">getHousesInfoCfg</button>
    <button id="btn-gql-logic">getGameLogicCfg</button>
    <button id="btn-gql-meat">updatePlayerMeat</button>
    <button id="btn-check-access">Проверить access (getPlayer)</button>
    <button id="btn-reload">Перезагрузить страницу</button>
</div>

<!-- СЕКЦИЯ ПОСТРОИТЬ ДОМ -->
<div class="row">
    <fieldset>
        <legend>Построить новый дом</legend>
        <div>
            <label>Тип:
                <select id="build-type">
                    <option value="FARM">FARM</option>
                    <option value="STORAGE">STORAGE</option>
                    <option value="DECOR">DECOR</option>
                </select>
            </label>
            <label>Skin:
                <input id="build-skin" type="text" value="default" style="width:120px;">
            </label>
            <label>X:
                <input id="build-x" type="number" value="0" style="width:70px;">
            </label>
            <label>Y:
                <input id="build-y" type="number" value="0" style="width:70px;">
            </label>
            <button id="btn-build">buildHouse</button>
        </div>
    </fieldset>
</div>

<!-- СЕКЦИЯ ДОМА (работаем с уже созданными) -->
<div class="row">
    <fieldset>
        <legend>Работа с существующими домами</legend>
        <div>
            <button id="btn-load-houses">Обновить список домов</button>
            <select id="sel-house">
                <option value="">(нет данных)</option>
            </select>
        </div>

        <div style="margin-top:6px;">
            <strong>Изменить локацию</strong><br>
            <label>X:
                <input id="move-x" type="number" value="1" style="width:70px;">
            </label>
            <label>Y:
                <input id="move-y" type="number" value="1" style="width:70px;">
            </label>
            <button id="btn-move">updateHouseLocation</button>
        </div>

        <div style="margin-top:6px;">
            <strong>Изменить скин</strong><br>
            <label>newSkin:
                <input id="skin-new" type="text" value="default" style="width:120px;">
            </label>
            <button id="btn-change-skin">updateHouseSkin</button>
        </div>

        <div style="margin-top:6px;">
            <strong>Повысить уровень</strong><br>
            <button id="btn-upgrade">updateHouseLevel</button>
        </div>

        <div style="margin-top:6px;">
            <strong>Удалить дом</strong><br>
            <button id="btn-delete">removeHouse</button>
        </div>
    </fieldset>
</div>

<div class="row">
    <fieldset>
        <legend>Конвертации</legend>
        <div>
            <label>Meat → Brain:
                <input id="conv-meat" type="number" value="10" style="width:90px;">
            </label>
            <button id="btn-conv-meat">convertMeatToBrain</button>
        </div>
        <div style="margin-top:6px;">
            <label>Brain → Gold:
                <input id="conv-brain" type="number" value="5" style="width:90px;">
            </label>
            <button id="btn-conv-brain">convertBrainToGold</button>
        </div>
    </fieldset>
</div>

<div class="row">
    <strong>Лог:</strong>
    <pre id="log"></pre>
</div>

<script>
    const BASE_URL = window.location.origin.startsWith("http")
        ? window.location.origin
        : "https://hzfarm.ru";

    const ACCESS_KEY = "hzf_access_token";
    let currentHouses = [];

    function log(...args) {
      const el = document.getElementById("log");
      const line = args.map(a => {
        if (typeof a === "string") return a;
        try { return JSON.stringify(a, null, 2); } catch (e) { return String(a); }
      }).join(" ");
      el.textContent = line + "\n" + el.textContent;
      console.log(...args);
    }

    function setAccess(token) {
      localStorage.setItem(ACCESS_KEY, token);
      renderAccess();
    }

    function getAccess() {
      return localStorage.getItem(ACCESS_KEY);
    }

    function renderAccess() {
      const t = getAccess();
      document.getElementById("access-text").textContent = t ? t : "(нет)";
    }

    async function onTelegramAuth(user) {
      try {
        log("telegram user:", user);
        const resp = await fetch(`${BASE_URL}/auth/telegram-login`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(user),
          credentials: "include"
        });

        const text = await resp.text();
        let json;
        try { json = JSON.parse(text); } catch (e) {}
        const access = json?.accessToken || json?.token || text;
        if (!access) {
          log("❌ авторизация: не получили access:", text);
          alert("не получили access, смотри лог");
          return;
        }
        setAccess(access);
        log("✅ авторизация: получили access");
      } catch (e) {
        log("❌ ошибка авторизации:", e);
      }
    }

    async function gqlFetch(query, variables = {}) {
      const token = getAccess();
      if (!token) {
        log("❗ нет access в localStorage");
        throw new Error("no access");
      }
      const resp = await fetch(`${BASE_URL}/graphql`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ query, variables })
      });
      const json = await resp.json();
      if (!resp.ok || json.errors) {
        log("❌ GQL error:", json);
        throw json;
      }
      return json;
    }

    function fillHousesSelect() {
      const sel = document.getElementById("sel-house");
      sel.innerHTML = "";
      if (!currentHouses.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "(нет домов)";
        sel.appendChild(opt);
        return;
      }
      currentHouses.forEach(h => {
        const opt = document.createElement("option");
        opt.value = h.id;
        opt.textContent = `${h.id} — ${h.type} (lvl ${h.level}) [${h.locationX},${h.locationY}] skin=${h.skin}`;
        sel.appendChild(opt);
      });
    }

    // refresh
    document.getElementById("btn-refresh").onclick = async () => {
      try {
        const resp = await fetch(`${BASE_URL}/auth/refresh`, {
          method: "POST",
          credentials: "include"
        });
        if (!resp.ok) {
          log("❌ refresh вернул", resp.status);
          return;
        }
        const data = await resp.json();
        const access = data.accessToken;
        setAccess(access);
        log("✅ refresh: новый access получен");
      } catch (e) {
        log("❌ ошибка refresh:", e);
      }
    };

    // check refresh
    document.getElementById("btn-check-refresh").onclick = async () => {
      const resp = await fetch(`${BASE_URL}/auth/refresh`, {
        method: "POST",
        credentials: "include"
      });
      log("check refresh → статус:", resp.status);
      if (resp.ok) {
        const data = await resp.json();
        log("refresh можно использовать, пришёл access:", data.accessToken);
      } else {
        log("refresh НЕЛЬЗЯ использовать (нет куки / истёк)");
      }
    };

    // базовые gql
    document.getElementById("btn-gql-player").onclick = async () => {
      const data = await gqlFetch(`{ getPlayer { id username meat gold brain boardColor houses { id type level locationX locationY skin } } }`);
      log("getPlayer:", data);
    };

    document.getElementById("btn-gql-houses").onclick = async () => {
      const data = await gqlFetch(`{ getHousesInfoCfg }`);
      log("getHousesInfoCfg:", data);
    };

    document.getElementById("btn-gql-logic").onclick = async () => {
      const data = await gqlFetch(`{ getGameLogicCfg }`);
      log("getGameLogicCfg:", data);
    };

    document.getElementById("btn-gql-meat").onclick = async () => {
      const data = await gqlFetch(`mutation { updatePlayerMeat { id username meat gold brain } }`);
      log("updatePlayerMeat:", data);
    };

    document.getElementById("btn-check-access").onclick = async () => {
      try {
        const data = await gqlFetch(`{ getPlayer { id } }`);
        log("✅ access живой:", data);
      } catch (e) {
        log("❌ access не работает:", e);
      }
    };

    document.getElementById("btn-clear").onclick = () => {
      localStorage.removeItem(ACCESS_KEY);
      renderAccess();
      log("localStorage access очищен");
    };

    document.getElementById("btn-reload").onclick = () => location.reload();

    // загрузить список домов
    document.getElementById("btn-load-houses").onclick = async () => {
      const data = await gqlFetch(`{ getPlayer { houses { id type level locationX locationY skin } } }`);
      currentHouses = data.data.getPlayer.houses || [];
      fillHousesSelect();
      log("Список домов обновлён:", currentHouses);
    };

    // build house (отдельная секция)
    document.getElementById("btn-build").onclick = async () => {
      const type = document.getElementById("build-type").value;
      const skin = document.getElementById("build-skin").value || "default";
      const x = Number(document.getElementById("build-x").value || 0);
      const y = Number(document.getElementById("build-y").value || 0);
      const q = `
        mutation($input: BuildHouseInput!) {
          buildHouse(input: $input) {
            id type level skin locationX locationY
          }
        }
      `;
      const vars = {
        input: {
          type,
          skin,
          locationX: x,
          locationY: y
        }
      };
      const data = await gqlFetch(q, vars);
      log("buildHouse:", data);
      // после создания обновим список
      document.getElementById("btn-load-houses").click();
    };

    // move house
    document.getElementById("btn-move").onclick = async () => {
      const sel = document.getElementById("sel-house");
      const houseId = sel.value;
      if (!houseId) { log("❗ выбери дом"); return; }
      const x = Number(document.getElementById("move-x").value || 0);
      const y = Number(document.getElementById("move-y").value || 0);
      const q = `
        mutation($input: UpdateHouseLocationInput!) {
          updateHouseLocation(input: $input) {
            id locationX locationY
          }
        }
      `;
      const vars = { input: { houseId, newLocationX: x, newLocationY: y } };
      const data = await gqlFetch(q, vars);
      log("updateHouseLocation:", data);
      document.getElementById("btn-load-houses").click();
    };

    // change skin
    document.getElementById("btn-change-skin").onclick = async () => {
      const sel = document.getElementById("sel-house");
      const houseId = sel.value;
      if (!houseId) { log("❗ выбери дом"); return; }
      const newSkin = document.getElementById("skin-new").value || "default";
      const q = `
        mutation($input: UpdateHouseSkinInput!) {
          updateHouseSkin(input: $input) {
            id skin
          }
        }
      `;
      const vars = { input: { houseId, newSkin } };
      const data = await gqlFetch(q, vars);
      log("updateHouseSkin:", data);
      document.getElementById("btn-load-houses").click();
    };

    // upgrade level
    document.getElementById("btn-upgrade").onclick = async () => {
      const sel = document.getElementById("sel-house");
      const houseId = sel.value;
      if (!houseId) { log("❗ выбери дом"); return; }
      const q = `
        mutation($input: HouseIdInput!) {
          updateHouseLevel(input: $input) {
            id level
          }
        }
      `;
      const data = await gqlFetch(q, { input: { houseId } });
      log("updateHouseLevel:", data);
      document.getElementById("btn-load-houses").click();
    };

    // delete house
    document.getElementById("btn-delete").onclick = async () => {
      const sel = document.getElementById("sel-house");
      const houseId = sel.value;
      if (!houseId) { log("❗ выбери дом"); return; }
      const q = `
        mutation($input: HouseIdInput!) {
          removeHouse(input: $input) {
            success
            deletedHouseId
          }
        }
      `;
      const data = await gqlFetch(q, { input: { houseId } });
      log("removeHouse:", data);
      document.getElementById("btn-load-houses").click();
    };

    // convert meat -> brain
    document.getElementById("btn-conv-meat").onclick = async () => {
      const amount = Number(document.getElementById("conv-meat").value || 0);
      const q = `
        mutation($input: ConvertMeatToBrainInput!) {
          convertMeatToBrain(input: $input) {
            id meat brain gold
          }
        }
      `;
      const data = await gqlFetch(q, { input: { meatToSpend: amount } });
      log("convertMeatToBrain:", data);
    };

    // convert brain -> gold
    document.getElementById("btn-conv-brain").onclick = async () => {
      const amount = Number(document.getElementById("conv-brain").value || 0);
      const q = `
        mutation($input: ConvertBrainToGoldInput!) {
          convertBrainToGold(input: $input) {
            id brain gold meat
          }
        }
      `;
      const data = await gqlFetch(q, { input: { brainToSpend: amount } });
      log("convertBrainToGold:", data);
    };

    // init
